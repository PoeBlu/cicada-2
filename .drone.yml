kind: pipeline
type: docker
name: default

steps:
  - name: publish-docs
    image: node:14
    environment:
      GIT_USER:
        from_secret: GIT_USER
      GIT_PASSWORD:
        from_secret: GIT_PASSWORD
    commands:
      - git config credential.helper '!f() { sleep 1; echo "username=${GIT_USER}"; echo "password=${GIT_PASSWORD}"; }; f'
      - cd docsite/website
      - npm install
      - npm run publish-gh-pages
    when:
      branch:
        - master
      event:
        - push
  - name: format
    image: python:3.8
    commands:
      - pip install black
      - black cicada2
  - name: lint
    image: python:3.8
    commands:
      - pip install pylint
      - pylint cicada2
  - name: test
    image: python:3.8
    commands:
    - pip install -r requirements.txt
    - pip install pytest
    - pytest
  - name: build-engine
    image: plugins/docker
    settings:
      dockerfile: dockerfiles/engine.dockerfile
      repo: jeremyaherzog/cicada-2-engine
      username:
        from_secret: DOCKER_USERNAME
      password:
        from_secret: DOCKER_PASSWORD
      tags:
        - 0.0.0  # NOTE: possibly derive from branch name/pr name or something when doing releases
        - latest
        - ${DRONE_COMMIT_SHA}
    commands: []
    when:
      branch:
        - master
      event:
        - push
  - name: build-rest-runner
    image: plugins/docker
    settings:
      dockerfile: dockerfiles/rest-runner.dockerfile
      repo: jeremyaherzog/cicada-2-rest-runner
      username:
        from_secret: DOCKER_USERNAME
      password:
        from_secret: DOCKER_PASSWORD
      tags:
        - 0.0.0
        - latest
        - ${DRONE_COMMIT_SHA}
    commands: []
    when:
      branch:
        - master
      event:
        - push
  - name: build-sql-runner
    image: plugins/docker
    settings:
      dockerfile: dockerfiles/sql-runner.dockerfile
      repo: jeremyaherzog/cicada-2-sql-runner
      username:
        from_secret: DOCKER_USERNAME
      password:
        from_secret: DOCKER_PASSWORD
      tags:
        - 0.0.0
        - latest
        - ${DRONE_COMMIT_SHA}
    commands: []
    when:
      branch:
        - master
      event:
        - push
